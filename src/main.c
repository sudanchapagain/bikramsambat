#include <stdio.h>
#include <time.h>
#include <string.h>
#include <ctype.h>
#include <stdlib.h>

#define VERSION "1.1.1"

typedef struct {
    int year;
    int month;
    int day;
} NepaliDate;

typedef struct {
    int year;
    int month;
    int day;
} EngDate;

static const int BS_DATA[91][13] = {
    { 2000, 30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31 },
    { 2001, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2002, 31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30 },
    { 2003, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2004, 30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31 },
    { 2005, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2006, 31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30 },
    { 2007, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2008, 31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 29, 31 },
    { 2009, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2010, 31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30 },
    { 2011, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2012, 31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30 },
    { 2013, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2014, 31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30 },
    { 2015, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2016, 31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30 },
    { 2017, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2018, 31, 32, 31, 32, 31, 30, 30, 29, 30, 29, 30, 30 },
    { 2019, 31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31 },
    { 2020, 31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2021, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2022, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30 },
    { 2023, 31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31 },
    { 2024, 31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2025, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2026, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2027, 30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31 },
    { 2028, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2029, 31, 31, 32, 31, 32, 30, 30, 29, 30, 29, 30, 30 },
    { 2030, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2031, 30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31 },
    { 2032, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2033, 31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30 },
    { 2034, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2035, 30, 32, 31, 32, 31, 31, 29, 30, 30, 29, 29, 31 },
    { 2036, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2037, 31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30 },
    { 2038, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2039, 31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30 },
    { 2040, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2041, 31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30 },
    { 2042, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2043, 31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30 },
    { 2044, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2045, 31, 32, 31, 32, 31, 30, 30, 29, 30, 29, 30, 30 },
    { 2046, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2047, 31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2048, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2049, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30 },
    { 2050, 31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31 },
    { 2051, 31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2052, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2053, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30 },
    { 2054, 31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31 },
    { 2055, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2056, 31, 31, 32, 31, 32, 30, 30, 29, 30, 29, 30, 30 },
    { 2057, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2058, 30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31 },
    { 2059, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2060, 31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30 },
    { 2061, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2062, 30, 32, 31, 32, 31, 31, 29, 30, 29, 30, 29, 31 },
    { 2063, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2064, 31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30 },
    { 2065, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2066, 31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 29, 31 },
    { 2067, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2068, 31, 31, 32, 32, 31, 30, 30, 29, 30, 29, 30, 30 },
    { 2069, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2070, 31, 31, 31, 32, 31, 31, 29, 30, 30, 29, 30, 30 },
    { 2071, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2072, 31, 32, 31, 32, 31, 30, 30, 29, 30, 29, 30, 30 },
    { 2073, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 31 },
    { 2074, 31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2075, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2076, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30 },
    { 2077, 31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31 },
    { 2078, 31, 31, 31, 32, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2079, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2080, 31, 32, 31, 32, 31, 30, 30, 30, 29, 29, 30, 30 },
    { 2081, 31, 32, 31, 32, 31, 30, 30, 30, 29, 30, 29, 31 },
    { 2082, 31, 31, 32, 31, 31, 31, 30, 29, 30, 29, 30, 30 },
    { 2083, 31, 31, 32, 31, 31, 30, 30, 30, 29, 30, 30, 30 },
    { 2084, 31, 31, 32, 31, 31, 30, 30, 30, 29, 30, 30, 30 },
    { 2085, 31, 32, 31, 32, 30, 31, 30, 30, 29, 30, 30, 30 },
    { 2086, 30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30 },
    { 2087, 31, 31, 32, 31, 31, 31, 30, 30, 29, 30, 30, 30 },
    { 2088, 30, 31, 32, 32, 30, 31, 30, 30, 29, 30, 30, 30 },
    { 2089, 30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30 },
    { 2090, 30, 32, 31, 32, 31, 30, 30, 30, 29, 30, 30, 30 }
};

static void
print_help(void) {
    printf("usage: bikramsambat [YYYY_MM_DD]\n");
    printf("       bikramsambat -h | --help\n");
    printf("       bikramsambat -v | --version\n");
}

static int
parse_date(const char *s, int *y, int *m, int *d) {
    if (strlen(s) != 10) {
        return 0;
    }

    if (s[4] != '_' || s[7] != '_') {
        return 0;
    }

    for (int i = 0; i < 10; i++) {
        if (i == 4 || i == 7) {
            continue;
        }

        if (!isdigit((unsigned char)s[i])) {
            return 0;
        }
    }

    *y = atoi(s);
    *m = atoi(s + 5);
    *d = atoi(s + 8);

    return 1;
}

static int
find_bs_row(int year) {
    for (int i = 0; i < 91; i++) {
        if (BS_DATA[i][0] == year) {
            return i;
        }
    }
    return -1;
}

static int
days_in_bs_month(int year, int month) {
    int row = find_bs_row(year);

    if (row < 0) {
        return 0;
    }

    return BS_DATA[row][month];
}

static EngDate
bs_to_ad(NepaliDate bs) {
    struct tm start = { 0 };
    start.tm_year = 1943 - 1900;
    start.tm_mon = 3;
    start.tm_mday = 14;

    time_t t = mktime(&start);

    int days = 0;

    for (int y = 2000; y < bs.year; y++) {
        for (int m = 1; m <= 12; m++) {
            days += days_in_bs_month(y, m);
        }
    }

    for (int m = 1; m < bs.month; m++) {
        days += days_in_bs_month(bs.year, m);
    }

    days += bs.day - 1;

    t += (time_t)days * 86400;

    struct tm *out = localtime(&t);

    EngDate ad;
    ad.year = out->tm_year + 1900;
    ad.month = out->tm_mon + 1;
    ad.day = out->tm_mday;

    return ad;
}

static NepaliDate
today_bs(void) {
    time_t now = time(NULL);
    struct tm *t = localtime(&now);

    struct tm start = { 0 };
    start.tm_year = 1943 - 1900;
    start.tm_mon = 3;
    start.tm_mday = 14;

    time_t s = mktime(&start);

    int diff = (int)((mktime(t) - s) / 86400);

    NepaliDate nd = { 2000, 1, 1 };

    while (diff > 0) {
        nd.day++;

        if (nd.day > days_in_bs_month(nd.year, nd.month)) {
            nd.day = 1;
            nd.month++;

            if (nd.month > 12) {
                nd.month = 1;
                nd.year++;
            }
        }
        diff--;
    }

    return nd;
}

int
main(int argc, char **argv) {
    int y, m, d;

    if (argc == 2) {
        if (!strcmp(argv[1], "-h") || !strcmp(argv[1], "--help")) {
            print_help();
            return 0;
        }

        if (!strcmp(argv[1],"-v") || !strcmp(argv[1],"--version")) {
            printf("%s\n", VERSION);
            return 0;
        }

        if (!parse_date(argv[1], &y, &m, &d)) {
            fprintf(stderr, "invalid date format\n");
            return 1;
        }

        if (find_bs_row(y) < 0 || m < 1 || m > 12 || d < 1 || d > days_in_bs_month(y, m)) {
            fprintf(stderr, "date out of range\n");
            return 1;
        }

        NepaliDate bs = { y, m, d };
        EngDate ad = bs_to_ad(bs);

        printf("%04d %02d %02d\n", ad.year, ad.month, ad.day);
        return 0;
    }

    if (argc == 1) {
        NepaliDate nd = today_bs();
        printf("%04d %02d %02d\n", nd.year, nd.month, nd.day);
        return 0;
    }

    print_help();
    return 1;
}
